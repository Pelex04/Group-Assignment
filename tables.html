<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css"
    />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Roboto:ital,wght@0,100;0,300;0,400;0,500;0,700;0,900;1,100;1,300;1,400;1,500;1,700;1,900&display=swap"
      rel="stylesheet"
    />
    <link rel="stylesheet" href="./css/site.css" />
    <title>Table</title>
    <style>
      .modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.5);
        z-index: 1000;
      }
      .modal-content {
        background-color: white;
        margin: 15% auto;
        padding: 20px;
        border: 1px solid #888;
        width: 80%;
        max-width: 500px;
        border-radius: 5px;
      }
      .modal-buttons {
        margin-top: 20px;
        text-align: right;
      }
      .modal-buttons button {
        padding: 8px 16px;
        margin-left: 10px;
        cursor: pointer;
      }
      .edit-form {
        display: none;
        margin: 20px 0;
        padding: 20px;
        border: 1px solid #ddd;
        border-radius: 5px;
      }
      .edit-form input {
        width: 100%;
        margin: 5px 0;
        padding: 8px;
      }
      .error {
        color: red;
        margin: 10px 0;
      }
    </style>
  </head>
  <body>
    <div class="header">
      <div class="toggle">
        <a id="toggle-nav"><i class="fa fa-navicon cog"></i></a>
      </div>
    </div>
    <div class="container">
      <div class="sidebar" id="sidebar">
        <a href="dashboard.html"><i class="fa fa-home"></i> Dashboard</a>
        <a href="form.html"><i class="fa fa-shopping-cart"></i> Forms</a>
        <a href="tables.html"><i class="fa fa-shopping-bag"></i> Tables</a>
      </div>
      <div class="content">
        <div class="left">
          <h3>Product Records</h3>
          <div class="section-container">
            <div class="section-header">Details of available products</div>
            <div class="section-content">
              <div id="edit-form" class="edit-form">
                <h4>Edit Product</h4>
                <input type="hidden" id="edit-id" />
                <input type="text" id="edit-name" placeholder="Product Name" />
                <input type="number" id="edit-price" placeholder="Price" />
                <input type="number" id="edit-quantity" placeholder="Quantity" />
                <input type="text" id="edit-description" placeholder="Description" />
                <div id="edit-error" class="error"></div>
                <button onclick="updateProduct()">Update</button>
                <button onclick="cancelEdit()">Cancel</button>
              </div>
              <table id="products-table" border="1" style="width:100%; border-collapse:collapse;">
                <thead>
                  <tr>
                    <th>ID</th>
                    <th>Name</th>
                    <th>Price</th>
                    <th>Quantity</th>
                    <th>Description</th>
                    <th></th>
                  </tr>
                </thead>
                <tbody></tbody>
              </table>
            </div>
          </div>
        </div>
        <div class="right"></div>
      </div>
    </div>
    <div id="deleteModal" class="modal">
      <div class="modal-content">
        <p>Are you sure you want to delete this product?</p>
        <div class="modal-buttons">
          <button onclick="confirmDelete()">Yes</button>
          <button onclick="cancelDelete()">No</button>
        </div>
      </div>
    </div>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script>
      let deleteProductId = null;

      $(document).ready(function() {
        fetchProductsWithLoading();
      });

      function showLoadingAnimation() {
        const loadingOverlay = document.createElement('div');
        loadingOverlay.id = 'loadingOverlay';
        loadingOverlay.style.cssText = `
          position: fixed;
          top: 0;
          left: 0;
          width: 100%;
          height: 100%;
          background-color: rgba(255, 255, 255, 0.9);
          display: flex;
          justify-content: center;
          align-items: center;
          z-index: 9999;
        `;
        
        const spinner = document.createElement('div');
        spinner.className = 'loader';
        spinner.innerHTML = `
          <div style="text-align: center;">
            <div style="font-size: 18px; margin-bottom: 15px; color: #4361ee;">Loading Products...</div>
            <div style="border: 5px solid #f3f3f3; border-top: 5px solid #4361ee; border-radius: 50%; width: 50px; height: 50px; animation: spin 1s linear infinite; margin: 0 auto;"></div>
          </div>
        `;
        
        const style = document.createElement('style');
        style.textContent = `
          @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
          }
        `;
        document.head.appendChild(style);
        
        loadingOverlay.appendChild(spinner);
        document.body.appendChild(loadingOverlay);
      }

      function hideLoadingAnimation() {
        const loadingOverlay = document.getElementById('loadingOverlay');
        if (loadingOverlay) {
          loadingOverlay.remove();
        }
      }

      function fetchProductsWithLoading() {
        showLoadingAnimation();
        setTimeout(() => {
          fetch('http://localhost:3000/products')
            .then(response => response.json())
            .then(data => {
              hideLoadingAnimation();
              createProductsTable(data);
            })
            .catch(error => {
              hideLoadingAnimation();
              $('#products-table tbody').html('<tr><td colspan="6">Failed to load data.</td></tr>');
              console.error('Error fetching products:', error);
            });
        }, 3000);
      }

      function createProductsTable(data) {
        const tbody = $('#products-table tbody');
        tbody.empty();
        data.forEach(product => {
          tbody.append(`
            <tr>
              <td>${product.id}</td>
              <td>${product.name}</td>
              <td>${product.price}</td>
              <td>${product.quantity}</td>
              <td>${product.description}</td>
              <td>
                <span style="color:blue; cursor:pointer;" onclick="editProduct(${product.id}, '${product.name}', ${product.price}, ${product.quantity}, '${product.description}')">Edit</span> 
                <span style="color:blue; cursor:pointer;" onclick="showDeleteModal(${product.id})">Delete</span>
              </td>
            </tr>
          `);
        });
      }

      function showDeleteModal(id) {
        deleteProductId = id;
        $('#deleteModal').show();
      }

      function cancelDelete() {
        $('#deleteModal').hide();
        deleteProductId = null;
      }

      function confirmDelete() {
        if (deleteProductId) {
          showLoadingAnimation();
          fetch(`http://localhost:3000/products/${deleteProductId}`, {
            method: 'DELETE'
          })
            .then(response => {
              if (response.ok) {
                fetchProductsWithLoading();
                $('#deleteModal').hide();
                deleteProductId = null;
              } else {
                throw new Error('Failed to delete product');
              }
            })
            .catch(error => {
              hideLoadingAnimation();
              console.error('Error deleting product:', error);
              alert('Failed to delete product');
            });
        }
      }

      function editProduct(id, name, price, quantity, description) {
        $('#edit-id').val(id);
        $('#edit-name').val(name);
        $('#edit-price').val(price);
        $('#edit-quantity').val(quantity);
        $('#edit-description').val(description);
        $('#edit-form').show();
        $('#edit-error').text('');
      }

      function cancelEdit() {
        $('#edit-form').hide();
        $('#edit-id').val('');
        $('#edit-name').val('');
        $('#edit-price').val('');
        $('#edit-quantity').val('');
        $('#edit-description').val('');
        $('#edit-error').text('');
      }

      function updateProduct() {
        const id = $('#edit-id').val();
        const product = {
          name: $('#edit-name').val(),
          price: parseFloat($('#edit-price').val()),
          quantity: parseInt($('#edit-quantity').val()),
          description: $('#edit-description').val()
        };

        if (!product.name || isNaN(product.price) || isNaN(product.quantity)) {
          $('#edit-error').text('Please fill in all required fields with valid values');
          return;
        }

        showLoadingAnimation();
        fetch(`http://localhost:3000/products/${id}`, {
          method: 'PUT',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(product)
        })
          .then(response => {
            if (response.ok) {
              fetchProductsWithLoading();
              cancelEdit();
            } else {
              throw new Error('Failed to update product');
            }
          })
          .catch(error => {
            hideLoadingAnimation();
            $('#edit-error').text('Failed to update product');
            console.error('Error updating product:', error);
          });
      }
    </script>
  </body>
</html>